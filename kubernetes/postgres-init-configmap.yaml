apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init
  namespace: kubechart
  labels:
    app: postgres
data:
  init.sql: |
    -- Create deployer user if it doesn't exist
    DO $$
    BEGIN
      IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = 'deployer_user') THEN
        CREATE USER deployer_user WITH PASSWORD 'deployer_password';
      END IF;
    END
    $$;

    -- Create database if it doesn't exist
    SELECT 'CREATE DATABASE kubechart OWNER deployer_user'
    WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'kubechart')\gexec

  post-init.sql: |
    -- Ensure permissions are always set correctly (run after DB is ready)
    -- Grant database privileges
    GRANT ALL PRIVILEGES ON DATABASE kubechart TO deployer_user;

    -- Connect to kubechart database
    \connect kubechart

    -- Create extensions if needed
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

    -- Grant schema privileges
    GRANT ALL PRIVILEGES ON SCHEMA public TO deployer_user;
    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO deployer_user;
    GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO deployer_user;
    GRANT ALL PRIVILEGES ON ALL FUNCTIONS IN SCHEMA public TO deployer_user;

    -- Set default privileges for future objects
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO deployer_user;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO deployer_user;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON FUNCTIONS TO deployer_user;
